const { MigrationInterface, QueryRunner } = require('typeorm');

class CreateUsersTable1640000000001 {
    async up(queryRunner) {
        await queryRunner.query(`
            CREATE TABLE "users" (
                "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                "name" varchar NOT NULL,
                "email" varchar UNIQUE NOT NULL,
                "password_hash" varchar NOT NULL,
                "role" users_role_enum NOT NULL DEFAULT 'member',
                "created_at" timestamp NOT NULL DEFAULT now(),
                "updated_at" timestamp NOT NULL DEFAULT now()
            );
        `);

        await queryRunner.query(`
            COMMENT ON COLUMN "users"."id" IS 'Primary UUID generated by gen_random_uuid()';
        `);

        // Create indexes
        await queryRunner.query(`CREATE INDEX "idx_users_email" ON "users" ("email");`);
        await queryRunner.query(`CREATE INDEX "idx_users_role" ON "users" ("role");`);
        await queryRunner.query(`CREATE INDEX "idx_users_created_at" ON "users" ("created_at");`);
    }

    async down(queryRunner) {
        await queryRunner.query(`DROP TABLE "users";`);
    }
}

module.exports = CreateUsersTable1640000000001;

// 1640000000000-CreateUsersTable

// const { MigrationInterface, QueryRunner, Table } = require("typeorm");

// class CreateUsersTable1640000000000 {
//     async up(queryRunner) {
//         try {
//             console.log('Starting CreateUsersTable migration...');

//             // Create the enum type for user roles (safe-guarded with DO block)
//             await queryRunner.query(`
//                 DO $$ BEGIN
//                     CREATE TYPE users_role_enum AS ENUM ('admin', 'mentor', 'student', 'member');
//                 EXCEPTION
//                     WHEN duplicate_object THEN null;
//                 END $$;
//             `);

//             // Enable uuid-ossp extension if not already enabled
//             await queryRunner.query(`
//                 CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
//             `);

//             // Create the users table
//             await queryRunner.createTable(new Table({
//                 name: "users",
//                 columns: [
//                     {
//                         name: "id",
//                         type: "uuid",
//                         isPrimary: true,
//                         generationStrategy: "uuid",
//                         default: "gen_random_uuid()"
//                     },
//                     {
//                         name: "name",
//                         type: "varchar",
//                         isNullable: false
//                     },
//                     {
//                         name: "email",
//                         type: "varchar",
//                         isUnique: true,
//                         isNullable: false
//                     },
//                     {
//                         name: "passwordhash",
//                         type: "varchar",
//                         isNullable: false
//                     },
//                     {
//                         name: "role",
//                         type: "enum",
//                         enumName: "users_role_enum", // explicitly bind enum type
//                         enum: ["admin", "mentor", "student", "member"],
//                         default: "'member'",
//                         isNullable: false
//                     },
//                     {
//                         name: "createdat",
//                         type: "timestamp",
//                         default: "now()",
//                         isNullable: false
//                     },
//                     {
//                         name: "updatedat",
//                         type: "timestamp",
//                         default: "now()",
//                         isNullable: false
//                     },
//                     {
//                         name: "assigned_to",
//                         type: "integer",
//                         isArray: true,
//                         isNullable: true
//                     }
//                 ]
//             }), true);

//             console.log('✅ CreateUsersTable migration completed successfully.');
//         } catch (error) {
//             console.error('❌ Error in CreateUsersTable migration:', error);
//             throw error;
//         }
//     }

//     async down(queryRunner) {
//         try {
//             console.log('Rolling back CreateUsersTable migration...');
//             await queryRunner.dropTable("users", true);
//             await queryRunner.query(`DROP TYPE IF EXISTS users_role_enum CASCADE;`);
//             console.log('✅ CreateUsersTable migration rolled back successfully.');
//         } catch (error) {
//             console.error('❌ Error rolling back CreateUsersTable migration:', error);
//             throw error;
//         }
//     }
// }

// module.exports = CreateUsersTable1640000000000;
