const { MigrationInterface, QueryRunner } = require('typeorm');

class CreateMessagesTable1640000000018 {
    async up(queryRunner) {
        await queryRunner.query(`
            CREATE TABLE "messages" (
                "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                "sender_id" uuid NOT NULL,
                "receiver_id" uuid NOT NULL,
                "message" text NOT NULL,
                "status" varchar(20) NOT NULL DEFAULT 'sent',
                "reply_to_message_id" int,
                "created_at" timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
            );
        `);

        // Add foreign key constraints with CASCADE DELETE
        await queryRunner.query(`
            ALTER TABLE "messages" 
            ADD CONSTRAINT "fk_messages_sender_id" 
            FOREIGN KEY ("sender_id") REFERENCES "users" ("id") ON DELETE CASCADE;
        `);

        await queryRunner.query(`
            ALTER TABLE "messages" 
            ADD CONSTRAINT "fk_messages_receiver_id" 
            FOREIGN KEY ("receiver_id") REFERENCES "users" ("id") ON DELETE CASCADE;
        `);

        await queryRunner.query(`
            ALTER TABLE "messages" 
            ADD CONSTRAINT "fk_messages_reply_to_message_id" 
            FOREIGN KEY ("reply_to_message_id") REFERENCES "messages" ("id") ON DELETE CASCADE;
        `);

        // Create indexes
        await queryRunner.query(`CREATE INDEX "idx_messages_sender_id" ON "messages" ("sender_id");`);
        await queryRunner.query(`CREATE INDEX "idx_messages_receiver_id" ON "messages" ("receiver_id");`);
        await queryRunner.query(`CREATE INDEX "idx_messages_reply_to_message_id" ON "messages" ("reply_to_message_id");`);
        await queryRunner.query(`CREATE INDEX "idx_messages_status" ON "messages" ("status");`);
        await queryRunner.query(`CREATE INDEX "idx_messages_created_at" ON "messages" ("created_at");`);
    }

    async down(queryRunner) {
        await queryRunner.query(`DROP TABLE "messages";`);
    }
}

module.exports = CreateMessagesTable1640000000018;
